<?xml version="1.0" encoding="UTF-8"?>
<excelConfig>
	<parameters>
		<!--保存时使用的模板,根据配置文件生成的excel,需要将数据保存为excel到本地,然后有save方法,再生成sql,保存到本地-->
		<parameter name="outputFilePath" value="C:\temo\OUT.xlsx" isShow="1"/>
		<!--<parameter isShow="1" name="template_FilePath" value="C:\00_Project\Jeesite070310\src\main\java\com\thinkgem\jeesite\common\excelConfig\test\xlsx\erp\enter\computer\computer.xlsx"/>-->
		<parameter isShow="1" name="template_FilePath" value="iphoneAndipad.xlsx"/>
		<parameter isShow="1" name="temlateSyntax" value="false"/>
		<parameter isShow="0" name="userId" class="java.lang.String" htmlType="select" desc="员工" isRequired="1" value="" modelId="personsQuery" />
		<parameter isShow="0" name="phoneNum" class="java.lang.String" htmlType="input" desc="手机号" isRequired="1" value="" modelId="" />

	</parameters>
	<models cls="">
		<!--
			引用多数据源,
			配置了全局参数
		-->
		<!--查询-->
		<model  id="personQuery">
			<SQLStrs>
				<sqlStr>
					<![CDATA[
						SELECT EName, EmployeeID FROM IT_User WHERE LEFT(EmployeeID ,1)='Z' ORDER  BY EName
					]]>
				</sqlStr>
			</SQLStrs>
		</model>
		<model  id="personsQuery">
			<SQLStrs>
				<sqlStr>
					<![CDATA[
						SELECT EName name, EmployeeID value FROM IT_User WHERE LEFT(EmployeeID ,1)='Z' ORDER  BY EName
					]]>
				</sqlStr>
			</SQLStrs>
		</model>
		<model  id="phoneQuery">
			<parameters>
				<parameter name="userId" class="java.lang.String"  value="$P!{userId}" />
				<parameter name="phoneNum" class="java.lang.String"  value="$P!{phoneNum}" />
			</parameters>
			<SQLStrs>
				<sqlStr>
					<![CDATA[
						SELECT b.currentEmployeeID, b.currentEmployeeName,a.QTY,a.SerialNo,a.Series,a.StockCode,a.ExpressCode,a.Memory,a.WarrantyStart,a.WarrantyEnd
						 FROM IT_Asset a
						JOIN (
						SELECT * FROM IT_Transaction a
						WHERE a.TransactionDate=(SELECT  max(b.TransactionDate) TransactionDate FROM IT_Transaction b WHERE a.assetSerialNo=b.assetSerialNo  )
						) b ON a.SerialNo=b.assetSerialNo
						WHERE Type='A2'
						<#if userId?? && userId != "">
							AND b.currentEmployeeID='$P!{userId}'
						</#if>
						<#if phoneNum?? && phoneNum != "">
							AND a.SerialNo='$P!{phoneNum}'
						</#if>
					]]>
				</sqlStr>
			</SQLStrs>
		</model>
		<!--保存-->
		<model  id="assetSave">
			<parameters >
				<parameter name="Status" class="java.lang.String"   value="$F!{Status}"/>
				<parameter name="QTY" class="java.lang.String"   value="$F!{QTY}"/>
				<parameter name="StockCode" class="java.lang.String"      value="$F!{StockCode}"/>
				<parameter name="SerialNo" class="java.lang.String"   value="$F!{SerialNo}"/>
				<parameter name="ExpressCode" class="java.lang.String"   value="$F!{ExpressCode}"/>
				<parameter name="Memory" class="java.lang.String"   value="$F!{Memory}"/>
				<parameter name="WarrantyStart" class="java.lang.String"   value="$F!{WarrantyStart}"/>
				<parameter name="WarrantyEnd" class="java.lang.String"   value="$F!{WarrantyEnd}"/>
				<parameter name="userId" class="java.lang.String" value="@@Userid"/>
			</parameters>
			<SQLStrs>
				<sqlStr>
					<![CDATA[

						IF
							(SELECT count(*) FROM IT_Asset WHERE SerialNo IN ('$P!{SerialNo}'))>0
						BEGIN
							IF '$P!{Status}' ='入库'
								BEGIN
									declare @error_mes varchar(1000)
									set @error_mes= (SELECT '库中已存在手机号为:$P!{SerialNo}的固定资产,不能再次选择入库,请选择归还')
									raiserror(@error_mes,16,1)
								END ELSE
								BEGIN
									UPDATE IT_Asset SET Field2='$P!{Status}' WHERE SerialNo = '$P!{SerialNo}'
								END
						END ELSE
						BEGIN
							INSERT INTO dbo.IT_Asset (ExpressCode,SerialNo,Field2,id, StockCode, Series, Type,  Memory,    ReceivedDate, WarrantyStart, WarrantyEnd, QTY, create_by, create_date, update_by, update_date, remarks, del_flag)
								VALUES ('$P!{ExpressCode}','$P!{SerialNo}','$P!{Status}',newId(), '$P!{StockCode}', '$P!{StockCode}', 'A2', '$P!{Memory}', getDate(),  '$P!{WarrantyStart}', '$P!{WarrantyEnd}', $P!{QTY}, '$P!{userId}', getDate(), '$P!{userId}', getDate(), '', '0')
						END
	        		]]>
				</sqlStr>
			</SQLStrs>
		</model>

		<model  id="transactionSave">
			<parameters >
				<parameter name="TransactionType" class="java.lang.String"      value="$F!{TransactionType}"/>
				<parameter name="beforeemployeeid" class="java.lang.String"   value="$F!{beforeemployeeid}"/>
				<parameter name="beforeemployeename" class="java.lang.String"   value="$F!{beforeemployeename}"/>
				<parameter name="assetserialno" class="java.lang.String"   value="$F!{assetserialno}"/>
				<parameter name="qty" class="java.lang.String"   value="$F!{qty}"/>
				<parameter name="assettype" class="java.lang.String"   value="$F!{assettype}"/>
				<parameter name="userid" class="java.lang.String" value="@@Userid"/>
			</parameters>
			<SQLStrs>
				<sqlStr>
					<![CDATA[
					  INSERT INTO dbo.IT_Transaction (id, TransactionDate, TransactionType, beforeEmployeeID, beforeEmployeeName, assetSerialNo, QTY, assetType, Remark, create_by, create_date, update_by, update_date, remarks, del_flag)
VALUES (newid(), getdate(), '$P!{TransactionType}','$P!{beforeemployeeid}', '$P!{beforeemployeename}', '$P!{assetserialno}', '$P!{qty}', '$P!{assettype}','',  '$P!{userid}', getdate(), '$P!{userid}', getdate(), '', '0')
			        ]]>
				</sqlStr>
			</SQLStrs>
		</model>
	</models>
	<!--查询视图-->
	<views   action="query">
		<view modelid="personQuery" sheetName="数据字典"   top="3" left="0">
			<propertys>
				<property 	cellIndex="0,1" feild="EName" 	type="java.lang.String"/>
				<property 	cellIndex="0,1" feild="EmployeeID" 	type="java.lang.String"/>
			</propertys>
		</view>
		<view modelid="phoneQuery" sheetName="iphoneAndipad"   top="2" left="0">
			<propertys>
				<property 	cellIndex="0,2" feild="currentEmployeeID" 	type="java.lang.String"/>
				<property 	cellIndex="0,1" feild="currentEmployeeName" 	type="java.lang.String"/>
				<property 	cellIndex="0,1" feild="QTY" 	type="java.lang.String"/>
				<property 	cellIndex="0,1" feild="SerialNo" 	type="java.lang.String"/>
				<property 	cellIndex="0,1" feild="ExpressCode" 	type="java.lang.String"/>
				<property 	cellIndex="0,1" feild="Series" 	type="java.lang.String"/>
				<property 	cellIndex="0,1" feild="Memory" 	type="java.lang.String"/>
				<property 	cellIndex="0,1" feild="WarrantyStart" 	type="java.lang.String"/>
				<property 	cellIndex="0,1" feild="WarrantyEnd" 	type="java.lang.String"/>
			</propertys>
		</view>
	</views>
	<!--保存视图-->
	<views   action="save">
		<view modelid="assetSave" sheetName="iphoneAndipad"  top="2" left="0">
			<propertys>
				<property cellIndex="0,1" feild="Status" required ="1"	type="java.lang.String" />
				<property cellIndex="0,3" feild="QTY" required ="1"	type="java.lang.String" />
				<property cellIndex="0,1" feild="SerialNo" required ="-1"	type="java.lang.String" />
				<property cellIndex="0,1" feild="ExpressCode" required ="-1"	type="java.lang.String" />
				<property cellIndex="0,1" feild="StockCode" required ="-1"	type="java.lang.String" />
				<property cellIndex="0,1" feild="Memory" required ="-1"	type="java.lang.String" />
				<property cellIndex="0,1" feild="WarrantyStart" required ="-1"	type="java.lang.String" />
				<property cellIndex="0,1" feild="WarrantyEnd" required ="-1"	type="java.lang.String" />
			</propertys>
		</view>
		<view modelid="transactionSave"  top="2" left="0">
			<propertys>
				<property 	cellIndex="0,1" feild="TransactionType" 	required ="-1" type="java.lang.String"/>
				<property 	cellIndex="0,1" feild="beforeemployeeid" required ="-1"  type="java.lang.Number" />
				<property 	cellIndex="0,1"	feild="beforeemployeename" required ="-1"	type="java.lang.String" />
				<property 	cellIndex="0,1"	feild="qty" required ="1"	type="java.lang.String" />
				<property 	cellIndex="0,1"	feild="assetserialno" required ="1"	type="java.lang.String" />
				<property 	cellIndex="0,1"	feild="assettype" required ="-1"	type="java.lang.String" />
				<property 	cellIndex="0,1"	feild="userid" required ="-1"	type="java.lang.String" />
			</propertys>
		</view>
	</views>
</excelConfig>